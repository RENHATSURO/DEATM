

local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local root = character:WaitForChild("HumanoidRootPart")


local TARGET_FOLDER = workspace:WaitForChild("Game")
    :WaitForChild("Jobs")
    :WaitForChild("CriminalATMSpawners")

local RANGE = 15 -- cube 30×30×30
local END_POS = Vector3.new(-2543.307861328125, 12.393211364746094, 4030.319091796875)

local lastVisit = {}  -- [spawner] = time()


local gui = Instance.new("ScreenGui")
gui.Name = "ATM_GUI"
gui.IgnoreGuiInset = true
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local main = Instance.new("Frame")
main.Size = UDim2.new(0, 340, 0, 420)
main.Position = UDim2.new(0, 40, 0.5, -210)
main.BackgroundColor3 = Color3.fromRGB(35,35,35)
main.BorderSizePixel = 0
main.Parent = gui

Instance.new("UICorner", main).CornerRadius = UDim.new(0, 12)

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1,0,0,40)
title.BackgroundTransparency = 1
title.Text = "Criminal ATM Tracker"
title.Font = Enum.Font.GothamBold
title.TextColor3 = Color3.fromRGB(255,255,255)
title.TextScaled = true
title.Parent = main

-- DRAGGABLE LOGIC
local dragging = false
local dragStart, startPos

main.InputBegan:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
		dragStart = i.Position
		startPos = main.Position
	end
end)

main.InputEnded:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = false
	end
end)

UIS.InputChanged:Connect(function(i)
	if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
		local delta = i.Position - dragStart
		main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X,
		                          startPos.Y.Scale, startPos.Y.Offset + delta.Y)
	end
end)


local endButton = Instance.new("TextButton")
endButton.Size = UDim2.new(0, 120, 0, 40)
endButton.Position = UDim2.new(0.5, -60, 0, 45)
endButton.Text = "END"
endButton.Font = Enum.Font.GothamBold
endButton.TextScaled = true
endButton.TextColor3 = Color3.new(1,1,1)
endButton.BackgroundColor3 = Color3.fromRGB(180,40,40)
endButton.BorderSizePixel = 0
endButton.Parent = main

Instance.new("UICorner", endButton).CornerRadius = UDim.new(0,10)

endButton.MouseButton1Click:Connect(function()
	root.CFrame = CFrame.new(END_POS + Vector3.new(0,3,0))
end)


local scroll = Instance.new("ScrollingFrame")
scroll.Size = UDim2.new(1, -20, 1, -100)
scroll.Position = UDim2.new(0, 10, 0, 90)
scroll.BackgroundColor3 = Color3.fromRGB(45,45,45)
scroll.ScrollBarThickness = 6
scroll.BorderSizePixel = 0
scroll.Parent = main

Instance.new("UICorner", scroll).CornerRadius = UDim.new(0,10)

local layout = Instance.new("UIListLayout")
layout.Padding = UDim.new(0,8)
layout.Parent = scroll

local entries = {}


local function clearUI()
	for _, obj in pairs(entries) do
		obj:Destroy()
	end
	entries = {}
end

local function rebuildUI()
	clearUI()

	-- get spawners
	local list = TARGET_FOLDER:GetChildren()

	-- init times if needed
	for _, sp in ipairs(list) do
		if lastVisit[sp] == nil then
			lastVisit[sp] = 0
		end
	end

	-- sort: by "oldest visit"
	table.sort(list, function(a,b)
		return lastVisit[a] < lastVisit[b]
	end)

	for _, sp in ipairs(list) do
		if sp:IsA("BasePart") then
			local frame = Instance.new("Frame")
			frame.Size = UDim2.new(1,0,0,46)
			frame.BackgroundColor3 = Color3.fromRGB(60,60,60)
			frame.BorderSizePixel = 0
			frame.Parent = scroll
			Instance.new("UICorner", frame).CornerRadius = UDim.new(0,10)

			local label = Instance.new("TextLabel")
			label.Size = UDim2.new(0.6,0,1,0)
			label.BackgroundTransparency = 1
			label.Text = sp.Name
			label.TextScaled = true
			label.Font = Enum.Font.Gotham
			label.TextColor3 = Color3.fromRGB(255,255,255)
			label.TextXAlignment = Enum.TextXAlignment.Left
			label.Parent = frame

			local tp = Instance.new("TextButton")
			tp.Size = UDim2.new(0.3,0,0.8,0)
			tp.Position = UDim2.new(0.65,0,0.1,0)
			tp.Text = "TP"
			tp.TextScaled = true
			tp.BackgroundColor3 = Color3.fromRGB(0,120,255)
			tp.TextColor3 = Color3.new(1,1,1)
			tp.BorderSizePixel = 0
			tp.Font = Enum.Font.GothamBold
			tp.Parent = frame
			Instance.new("UICorner", tp).CornerRadius = UDim.new(0,10)

			tp.MouseButton1Click:Connect(function()
				if sp.Parent then
					root.CFrame = sp.CFrame + Vector3.new(0,4,0)
				end
			end)

			entries[sp] = frame
		end
	end

	scroll.CanvasSize = UDim2.new(0,0,0,layout.AbsoluteContentSize.Y + 20)
end


task.spawn(function()
	while true do
		for _, sp in ipairs(TARGET_FOLDER:GetChildren()) do
			if sp:IsA("BasePart") then
				local pos = root.Position
				local center = sp.Position

				local dx = math.abs(pos.X - center.X)
				local dy = math.abs(pos.Y - center.Y)
				local dz = math.abs(pos.Z - center.Z)

				local inside = (dx <= RANGE and dy <= RANGE and dz <= RANGE)

				if inside then
					lastVisit[sp] = os.clock()
				end
			end
		end

		rebuildUI()
		task.wait(0.2)
	end
end)

rebuildUI()

